<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COCOç†Šæœ¬ç•¢æ—… (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- 1. å…¨å±€è¨­å®š --- */
        :root {
            --bg-color: #F9F9F7;
            --card-bg: #FFFFFF;
            --text-main: #333333;
            --text-sub: #888888;
            --radius: 12px;
            --shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #eee; margin: 0; padding: 0;
            display: flex; justify-content: center; color: var(--text-main);
        }

        #app {
            width: 100%; max-width: 480px; min-height: 100vh;
            background: var(--bg-color); position: relative; padding-bottom: 80px;
        }

        /* --- 2. Header --- */
        header {
            background: rgba(255,255,255,0.95); padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; height: 60px;
        }
        h1 { margin: 0; font-size: 18px; font-weight: bold; }
        .back-btn { font-size: 20px; color: var(--text-main); cursor: pointer; border: none; background: none; display: none; }

        /* --- 3. Dashboard --- */
        #view-dashboard { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; animation: fadeIn 0.3s; }
        .day-block {
            background: var(--card-bg); padding: 15px 10px; border-radius: var(--radius);
            box-shadow: var(--shadow); text-align: center; cursor: pointer; transition: transform 0.1s; position: relative;
        }
        .day-block:active { transform: scale(0.95); }
        .day-num { font-size: 12px; color: var(--text-sub); font-weight: bold; }
        .day-date { font-size: 16px; font-weight: bold; margin: 4px 0; color: #333; }
        .day-loc { font-size: 12px; color: #666; margin-bottom: 6px; }
        .day-weather {
            display: inline-block; background: #F0F8FF; color: #56CCF2;
            padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 1px solid #E0F0FF;
        }

        /* --- 4. Detail View --- */
        #view-detail { display: none; padding: 15px; animation: slideIn 0.3s; }
        .card {
            background: #fff; margin-bottom: 15px; padding: 15px;
            border-radius: var(--radius); box-shadow: var(--shadow);
            border-left: 5px solid #ccc; position: relative;
            /* è®“å¡ç‰‡åœ¨æ‹–æ›³æ™‚æ›´å¹³æ»‘ */
            touch-action: none; 
        }
        .type-spot { border-left-color: #F2C94C; } .type-food { border-left-color: #EB5757; }
        .type-transport { border-left-color: #56CCF2; background: #F0FAFF; } .type-stay { border-left-color: #6FCF97; }

        .card-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-time { font-size: 14px; font-weight: bold; color: #555; width: 50px; }
        .card-content { flex: 1; }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
        .card-cost { display: inline-block; background: #FFF9E6; color: #B07C3D; font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px;}
        .card-desc { font-size: 13px; color: #666; line-height: 1.5; white-space: pre-line; }
        .action-btns { display: flex; gap: 8px; margin-left: 10px; align-items: flex-start;}
        .icon-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #eee; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
        .btn-link { color: #27AE60; border-color: #D5F5E3; background: #EAFAF1; }

        /* Sortable æ¨£å¼å„ªåŒ– */
        .sortable-ghost { opacity: 0.4; background: #eee; border: 2px dashed #999; }
        .sortable-chosen { background: #fdfdfd; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transform: scale(1.02); z-index: 10; }
        .sortable-drag { opacity: 1; }

        /* --- 5. Tool Styles --- */
        #view-tools { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .tool-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tool-block {
            background: #fff; padding: 25px 15px; border-radius: 16px; box-shadow: var(--shadow);
            text-align: center; cursor: pointer; transition: transform 0.1s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        .tool-block:active { transform: scale(0.96); }
        .tool-icon-box {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-bottom: 5px;
        }
        .tool-title { font-weight: bold; color: #333; font-size: 15px; }
        .tool-subview { display: none; animation: slideIn 0.3s; }

        /* Flight & Train Styles */
        .flight-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 15px; border-left: 6px solid #56CCF2; cursor: pointer; }
        .flight-number { font-size: 28px; font-weight: 800; color: #333; margin: 5px 0; }
        .flight-route { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: bold; color: #555; }
        .link-item { background: #fff; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 12px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .link-icon { width: 40px; height: 40px; background: #F0FAFF; color: #56CCF2; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .train-menu { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .train-block { background: #F0FFF4; border: 1px solid #6FCF97; color: #27AE60; padding: 30px; border-radius: 16px; text-align: center; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: var(--shadow); }
        .seat-card { background: #fff; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 15px; overflow: hidden; }
        .seat-img { width: 100%; height: 140px; object-fit: cover; background: #eee; }
        .seat-info { padding: 15px; }
        .seat-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }

        /* --- 6. Budget Notebook --- */
        .budget-person-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .budget-person-card {
            background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 15px; cursor: pointer;
        }
        .avatar-circle {
            width: 40px; height: 40px; background: #333; color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;
        }
        
        #budget-notebook {
            background-color: #fff;
            background-image: linear-gradient(#e1e1e1 1px, transparent 1px);
            background-size: 100% 50px; 
            min-height: 80vh;
            padding-bottom: 80px;
            position: relative;
        }
        .notebook-header {
            background: #f8f8f8; padding: 10px 15px; border-bottom: 2px solid #ccc;
            font-size: 12px; font-weight: bold; color: #888; display: flex;
        }
        .nb-row {
            height: 50px; display: flex; align-items: center; padding: 0 15px;
            font-size: 15px; color: #333; user-select: none; -webkit-user-select: none;
        }
        .nb-row:active { background-color: rgba(0,0,0,0.05); }
        
        .col-date { width: 50px; font-size: 13px; color: #888; }
        .col-type { width: 40px; font-size: 18px; text-align: center; margin-right: 10px;}
        .col-content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .col-cost { width: 80px; text-align: right; font-weight: bold; color: #B07C3D; font-family: monospace; font-size: 16px;}
        
        .budget-total-bar {
            position: fixed; bottom: 60px; left: 0; width: 100%;
            background: #333; color: #fff; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 90;
        }
        
        /* FAB */
        .fab {
            position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px;
            background: #333; color: #fff; border-radius: 50%; display: none;
            align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 150;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(3px);
        }
        .modal-box {
            background: #fff; width: 85%; max-width: 400px; padding: 20px;
            border-radius: 12px; animation: popUp 0.2s;
        }
        .form-group { margin-bottom: 12px; }
        .form-input, .form-select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background:#fff;}
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-save { background: #333; color: #fff; }
        .btn-del { background: #fff; border: 1px solid #EB5757; color: #EB5757; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 480px;
            background: #fff; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-item { text-align: center; color: #ccc; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: #333; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popUp { from { transform: scale(0.9); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div id="app">
    <header>
        <button class="back-btn" onclick="handleBack()"><i class="fas fa-arrow-left"></i></button>
        <h1 id="page-title">COCOç†Šæœ¬ç•¢æ—…</h1>
        <div style="width: 20px;"></div>
    </header>

    <div id="view-dashboard"></div>

    <div id="view-detail">
        <div id="event-list"></div>
        <div style="height: 60px;"></div>
    </div>

    <div id="view-tools">
        <div id="tools-menu" class="tool-menu">
            <div class="tool-block" onclick="window.open('https://tenki.jp/', '_blank')">
                <div class="tool-icon-box" style="background:#FFF5F5; color:#EB5757;"><i class="fas fa-sun"></i></div>
                <div class="tool-title">å¤©æ°£é å ±</div>
            </div>
            <div class="tool-block" onclick="openToolSub('flight')">
                <div class="tool-icon-box" style="background:#F0FAFF; color:#56CCF2;"><i class="fas fa-plane"></i></div>
                <div class="tool-title">èˆªç­è³‡è¨Š</div>
            </div>
            <div class="tool-block" onclick="openToolSub('train')">
                <div class="tool-icon-box" style="background:#F0FFF4; color:#6FCF97;"><i class="fas fa-train"></i></div>
                <div class="tool-title">é›»è»Šèˆ‡æ™‚é–“è¡¨</div>
            </div>
            <div class="tool-block" onclick="openBudgetMenu()">
                <div class="tool-icon-box" style="background:#FFF9E6; color:#B07C3D;"><i class="fas fa-wallet"></i></div>
                <div class="tool-title">è¨˜å¸³æœ¬</div>
            </div>
        </div>
        <div id="tool-content" class="tool-subview"></div>
        <div id="budget-notebook" class="tool-subview" style="display:none;"></div>
    </div>

    <div class="fab" id="fab-add" onclick="handleAddClick()">
        <i class="fas fa-plus"></i>
    </div>
    
    <div id="budget-total-bar" class="budget-total-bar" style="display:none;">
        <div>ç¸½è¨ˆ</div>
        <div style="text-align:right;">
            <div id="total-val">Â¥0</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-map-marked-alt"></i> è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchTab('tools')"><i class="fas fa-suitcase"></i> å·¥å…·</div>
    </div>
</div>

<div class="modal-overlay" id="budget-modal">
    <div class="modal-box">
        <h3 id="budget-modal-title">æ–°å¢æ”¯å‡º</h3>
        <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="text" id="b-date" class="form-input" placeholder="1/19"></div>
        <div class="form-group"><label class="form-label">ç¨®é¡</label>
            <select id="b-type" class="form-select">
                <option value="food">ğŸœ åƒ</option>
                <option value="transport">ğŸš… äº¤é€š</option>
                <option value="spot">ğŸ« æ™¯é»</option>
                <option value="stay">ğŸ¨ ä½å®¿</option>
                <option value="other">ğŸ›ï¸ å…¶ä»–</option>
            </select>
        </div>
        <div class="form-group"><label class="form-label">å…§å®¹</label><input type="text" id="b-title" class="form-input" placeholder="é …ç›®åç¨±"></div>
        <div class="form-group"><label class="form-label">é‡‘é¡</label><input type="number" id="b-cost" class="form-input" placeholder="1000"></div>
        
        <div class="btn-group">
            <button class="btn btn-del" id="b-btn-delete" style="display:none;" onclick="deleteBudgetItem()">åˆªé™¤</button>
            <button class="btn" style="background:#eee;" onclick="closeBudgetModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveBudgetItem()">å„²å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="itinerary-modal">
    <div class="modal-box">
        <h3 id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
        <div class="form-group"><label class="form-label">æ™‚é–“</label><input type="text" id="inp-time" class="form-input"></div>
        <div class="form-group"><label class="form-label">é¡å‹</label><select id="inp-type" class="form-select"><option value="spot">ğŸ“ æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="transport">ğŸš… äº¤é€š</option><option value="stay">ğŸ¨ ä½å®¿</option></select></div>
        <div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input type="text" id="inp-title" class="form-input"></div>
        <div class="form-group"><label class="form-label">é€£çµ</label><input type="text" id="inp-link" class="form-input"></div>
        <div class="form-group"><label class="form-label">åœ°åœ–</label><input type="text" id="inp-map" class="form-input"></div>
        <div class="form-group"><label class="form-label">è²»ç”¨</label><input type="text" id="inp-cost" class="form-input"></div>
        <div class="form-group"><label class="form-label">å‚™è¨»</label><textarea id="inp-desc" class="form-input" rows="3"></textarea></div>
        <div class="btn-group">
            <button class="btn btn-del" id="btn-delete" onclick="deleteEvent()">åˆªé™¤</button>
            <button class="btn" style="background:#eee;" onclick="closeItineraryModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveEvent()">å„²å­˜</button>
        </div>
    </div>
</div>

<script type="module">
    // --- 1. Firebase è¨­å®šèˆ‡åˆå§‹åŒ– ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ Firebase è¨­å®š (å¾ Firebase Console -> Project Settings -> General -> Your apps è¤‡è£½)
    const firebaseConfig = {
      apiKey: "AIzaSyDGNRpSoWB9VHKjzIk9qsMEB-kzRvFJr3Y",
      authDomain: "coco-525eb.firebaseapp.com",
      projectId: "coco-525eb",
      storageBucket: "coco-525eb.firebasestorage.app",
      messagingSenderId: "472898703212",
      appId: "1:472898703212:web:0bc5fa2751ab45ad68ed49",
      measurementId: "G-F0VSKJCSTT"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // æˆ‘å€‘å°‡æ‰€æœ‰è³‡æ–™å­˜åœ¨ "trips" é›†åˆä¸‹çš„ "coco_kumamoto" æ–‡ä»¶ä¸­
    const docRef = doc(db, "trips", "coco_kumamoto");

    // --- 2. åŸå§‹è³‡æ–™çµæ§‹ ---
    const defaultTrip = [
        { date: "Day 1", fullDate: "1/19 (æ—¥)", loc: "æŠµé”ç†Šæœ¬", weather: "â˜ï¸ 7Â°C", events: [
            { time: "14:30", type: "transport", title: "é£›æ©Ÿå‡ºç™¼ (CI194)", cost: "", desc: "17:30 æŠµé”ç†Šæœ¬æ©Ÿå ´" },
            { time: "19:00", type: "transport", title: "æ©Ÿå ´ç›´é”å·´å£«", cost: "Â¥1200", link: "https://www.sankobus.jp/bus/airport/", desc: "19:42 æŠµé”æ«»ç”º/ç†Šæœ¬å¸‚å…§" },
            { time: "æ™šä¸Š", type: "spot", title: "ç†Šæœ¬å‘¨éŠåˆ¸", cost: "", desc: "ä¸æ˜¯ç©ºæ¸¯ç›´é”å·´å£«çš„è©±ä¸èƒ½ç”¨" },
            { time: "ä½å®¿", type: "stay", title: "SUPER HOTEL Kumamoto", cost: "Â¥3310", link: "https://www.superhotel.co.jp/", desc: "ç†Šæœ¬è»Šç«™æ­£å°é¢ï¼Œå«æº«æ³‰èˆ‡æ—©é¤" }
        ]},
        { date: "Day 2", fullDate: "1/20 (ä¸€)", loc: "åˆ¥åºœ", weather: "â›… 8Â°C", events: [
            { time: "10:03", type: "transport", title: "ä¹å·æ–°å¹¹ç·š -> åˆ¥åºœ", cost: "", desc: "10:45 æŠµé”" },
            { time: "11:00", type: "transport", title: "Sonic éŸ³é€Ÿè™Ÿ", cost: "", desc: "12:50 æŠµé”åˆ¥åºœ" },
            { time: "åˆé¤", type: "food", title: "åˆ¥åºœç•¶åœ°åˆé¤", cost: "", desc: "" },
            { time: "äº¤é€š", type: "transport", title: "é¾œä¹‹äº•å·´å£«ä¸€æ—¥åˆ¸", cost: "", link: "https://kamenoibus.com/guruspamp/guruspa/01/index.html", desc: "My Beppu Free" },
            { time: "ä¸‹åˆ", type: "spot", title: "åˆ¥åºœåœ°ç„å·¡ç¦®", cost: "", link: "http://www.beppu-jigoku.com/", desc: "Beppu Jigoku" },
            { time: "å‚æ™š", type: "spot", title: "è‘«è˜†æº«æ³‰ (Hyotan Onsen)", cost: "", desc: "ç ‚æ¹¯ã€æ—¥æ­¸æº«æ³‰" },
            { time: "æ™šä¸Š", type: "spot", title: "æ¹¯ç…™å±•æœ›å°", cost: "", desc: "Yukemuri Observation Deck" },
            { time: "ä½å®¿", type: "stay", title: "GRAND BASE Beppueki", cost: "Â¥3800", desc: "åˆ¥åºœè»Šç«™é™„è¿‘" }
        ]},
        { date: "Day 3", fullDate: "1/21 (äºŒ)", loc: "ç¦å²¡åšå¤š", weather: "â˜€ï¸ 9Â°C", events: [
            { time: "ä¸Šåˆ", type: "transport", title: "Sonic éŸ³é€Ÿè™Ÿ -> åšå¤š", cost: "", desc: "å‰å¾€ç¦å²¡" },
            { time: "ä¸‹åˆ", type: "spot", title: "ä½å‰ç¥ç¤¾", cost: "", desc: "Sumiyoshi Shrine" },
            { time: "ä¸‹åˆ", type: "spot", title: "æ«›ç”°ç¥ç¤¾", cost: "", desc: "Kushida Shrine" },
            { time: "æ™šé¤", type: "food", title: "åšå¤šç‰›è…¸é‹", cost: "", desc: "Motsunabe" },
            { time: "æ™šä¸Š", type: "spot", title: "å¤©ç¥åœ°ä¸‹è¡—", cost: "", desc: "ç‡Ÿæ¥­è‡³ 20:00" },
            { time: "æ™šä¸Š", type: "spot", title: "åšå¤šé‹æ²³åŸ", cost: "", desc: "ç‡Ÿæ¥­è‡³ 21:00" },
            { time: "ä½å®¿", type: "stay", title: "alfacio riverside stay hakata", cost: "Â¥2400", desc: "ä¸­æ´²å·ç«¯é™„è¿‘ (é€£ä½ä¸‰æ™š)" }
        ]},
        { date: "Day 4", fullDate: "1/22 (ä¸‰)", loc: "é•·å´ä¸€æ—¥éŠ", weather: "ğŸŒ§ï¸ 6Â°C", events: [
            { time: "ä¸Šåˆ", type: "transport", title: "æ¥åŠ›æµ·é·—è™Ÿ -> é•·å´", cost: "", desc: "ç´„ 1h40min" },
            { time: "äº¤é€š", type: "transport", title: "é•·å´é›»è»Šä¸€æ—¥ä¹˜è»Šåˆ¸", cost: "", desc: "è·¯é¢é›»è»Š" },
            { time: "æ™¯é»", type: "spot", title: "å‡ºå³¶ Dejima", cost: "Â¥520", desc: "è·è˜­å•†é¤¨éºè·¡" },
            { time: "æ™¯é»", type: "spot", title: "å“¥æ‹‰å·´åœ’ & å¤§æµ¦å¤©ä¸»å ‚", cost: "Â¥620", desc: "Glover Garden" },
            { time: "æ™¯é»", type: "spot", title: "é•·å´åŸçˆ†è³‡æ–™é¤¨", cost: "Â¥200", desc: "å’Œå¹³å…¬åœ’" },
            { time: "æ™¯é»", type: "spot", title: "æµ¦ä¸Šå¤©ä¸»å ‚", cost: "", desc: "Urakami Cathedral" },
            { time: "æ™¯é»", type: "spot", title: "å±±ç‹ç¥ç¤¾ äºŒä¹‹é³¥å±…", cost: "", desc: "å–®è…³é³¥å±…" },
            { time: "æ™šä¸Š", type: "spot", title: "ç¨»ä½å±±å¤œæ™¯", cost: "Â¥1250", link: "https://www.inasayama.com/", desc: "JRé•·å´ç«™æœ‰å…è²»æ¥é§å·´å£«(éœ€é ç´„)" },
            { time: "å›ç¨‹", type: "transport", title: "è¥¿ä¹å·æ–°å¹¹ç·š -> åšå¤š", cost: "", desc: "è¿”å›ç¦å²¡" },
            { time: "ä½å®¿", type: "stay", title: "alfacio riverside stay hakata", cost: "Â¥2400", desc: "çºŒä½" }
        ]},
        { date: "Day 5", fullDate: "1/23 (å››)", loc: "ç¦å²¡è‡ªç”±", weather: "â˜ï¸ 8Â°C", events: [
            { time: "å…¨å¤©", type: "spot", title: "è‡ªç”±æ´»å‹•", cost: "", desc: "åšå¤šé›†åˆ" },
            { time: "æ™šé¤", type: "food", title: "æ™šé¤", cost: "", desc: "" },
            { time: "ä½å®¿", type: "stay", title: "alfacio riverside stay hakata", cost: "Â¥2400", desc: "çºŒä½" }
        ]},
        { date: "Day 6", fullDate: "1/24 (äº”)", loc: "ç¦å²¡/ç†Šæœ¬", weather: "â˜€ï¸ 10Â°C", events: [
            { time: "ä¸Šåˆ", type: "spot", title: "è‡ªç”±æ´»å‹•", cost: "", desc: "å»ºè­°: é•·å´/è»è‰¦å³¶/è±ªæ–¯ç™»å ¡/å³¶åŸ" },
            { time: "16:00", type: "transport", title: "ä¹å·æ–°å¹¹ç·š -> ç†Šæœ¬", cost: "", desc: "16:48 æŠµé”ç†Šæœ¬" },
            { time: "äº¤é€š", type: "transport", title: "ç†Šæœ¬å¸‚é›»", cost: "", desc: "" },
            { time: "æ™¯é»", type: "spot", title: "ç†Šæœ¬åŸ & æ«»ä¹‹é¦¬å ´", cost: "", desc: "Kumamoto Castle & Josaien" },
            { time: "ä½å®¿", type: "stay", title: "fav KUMAMOTO", cost: "Â¥4000", link: "https://fav-hotels.com/hotels/kumamoto/", desc: "å…©é›™å…©å–®åºŠ" }
        ]},
        { date: "Day 7", fullDate: "1/25 (å…­)", loc: "é˜¿è˜‡è‡ªé§•", weather: "â›… 4Â°C", events: [
            { time: "å…¨å¤©", type: "transport", title: "é˜¿è˜‡ç§Ÿè»Šè‡ªé§•", cost: "", desc: "" },
            { time: "æ™¯é»", type: "spot", title: "è‰åƒé‡Œå±•æœ›æ‰€", cost: "", desc: "Kusasenri Observatory" },
            { time: "æ™¯é»", type: "spot", title: "é˜¿è˜‡ä¸­å²³ç«å±±å£", cost: "Â¥800", link: "http://www.aso.ne.jp/~volcano/", desc: "è¦–æ°£é«”æ¿ƒåº¦é–‹æ”¾" },
            { time: "åˆé¤", type: "food", title: "é˜¿è˜‡èµ¤ç‰›ä¸¼", cost: "Â¥1800", desc: "Aso Red Beef Bowl" },
            { time: "æ™¯é»", type: "spot", title: "é“ä¹‹é©› é˜¿è˜‡", cost: "", desc: "Aso Roadside Station" },
            { time: "æ™¯é»", type: "spot", title: "å¤§è§€å³°", cost: "", desc: "Daikanbo" },
            { time: "æ™¯é»", type: "spot", title: "ä¸Šè‰²è¦‹ç†Šé‡åº§ç¥ç¤¾", cost: "", desc: "è¦–å¤©æ°£æ±ºå®š" },
            { time: "ä½å®¿", type: "stay", title: "fav KUMAMOTO", cost: "Â¥4000", desc: "çºŒä½" }
        ]},
        { date: "Day 8", fullDate: "1/26 (æ—¥)", loc: "å›ç¨‹", weather: "â˜€ï¸ 11Â°C", events: [
             { time: "ä¸Šåˆ", type: "spot", title: "ç†Šæœ¬ç†Šéƒ¨é•·è¾¦å…¬å®¤", cost: "", link: "https://www.kumamon-sq.jp/", desc: "Kumamon Square" },
             { time: "æ™¯é»", type: "spot", title: "æ°´å‰å¯ºæˆè¶£åœ’", cost: "", desc: "" },
             { time: "ä¸‹åˆ", type: "transport", title: "æ«»ç”º -> æ©Ÿå ´å·´å£«", cost: "", desc: "" },
             { time: "18:30", type: "transport", title: "é£›æ©Ÿå›ç¨‹ (CI195)", cost: "", desc: "20:05 æŠµé”å°åŒ—" }
        ]}
    ];
    const defaultBudget = { "ç‹å¿—çœŸ": [], "ç‹å£«æ™‰": [], "æ±Ÿç«‘ç·¯": [], "èƒ¡æœæ˜±": [], "ä»»ç¿”": [] };

    // --- 3. å…¨å±€è®Šæ•¸ ---
    let tripData = [];
    let budgetData = {};
    let currentDayIdx = null;
    let editEventIdx = null;
    let currentView = 'dashboard'; 
    let navHistory = []; 
    let currentBudgetPerson = null;
    let editingBudgetIdx = null;

    // --- 4. æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šä½¿ç”¨ Firebase ---
    
    // åˆå§‹åŒ–ï¼šç›£è½é›²ç«¯è³‡æ–™
    function init() {
        console.log("æ­£åœ¨é€£æ¥ Firebase...");
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                // é›²ç«¯æœ‰è³‡æ–™ï¼Œä¸‹è¼‰ä¸¦æ›´æ–°ç•«é¢
                const cloudData = docSnap.data();
                tripData = cloudData.tripData || [];
                budgetData = cloudData.budgetData || {};
                console.log("é›²ç«¯è³‡æ–™åŒæ­¥æˆåŠŸ");
                
                // æ ¹æ“šç•¶å‰é é¢åˆ·æ–° UI
                if(currentView === 'dashboard') renderDashboard();
                else if(currentView === 'detail') renderEvents();
                else if(currentView === 'budget-detail') renderBudgetList();
            } else {
                // é›²ç«¯æ²’è³‡æ–™ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰ï¼ŒæŠŠé è¨­è³‡æ–™ä¸Šå‚³
                console.log("åˆå§‹åŒ–æ–°è³‡æ–™åº«...");
                tripData = JSON.parse(JSON.stringify(defaultTrip));
                budgetData = JSON.parse(JSON.stringify(defaultBudget));
                saveToCloud(); // å­˜ä¸Šå»
                renderDashboard();
            }
        });
    }

    // çµ±ä¸€çš„å„²å­˜å‡½æ•¸ï¼šä¸Šå‚³åˆ°é›²ç«¯
    async function saveToCloud() {
        try {
            await setDoc(docRef, {
                tripData: tripData,
                budgetData: budgetData
            }, { merge: true });
            console.log("å„²å­˜æˆåŠŸ");
        } catch (e) {
            console.error("å„²å­˜å¤±æ•—: ", e);
            alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¨­å®š");
        }
    }

    // å–ä»£èˆŠçš„ saveData / saveBudget
    window.saveData = saveToCloud;
    window.saveBudget = saveToCloud;

    // --- 5. UI é‚è¼¯ (å¤§éƒ¨åˆ†ä¿æŒä¸è®Šï¼Œä½†éœ€æ›è¼‰åˆ° window) ---
    // å› ç‚º type="module" æœƒè®“å‡½æ•¸è®Šç‚ºå€åŸŸè®Šæ•¸ï¼ŒHTML onclick æœƒæŠ“ä¸åˆ°ï¼Œæ‰€ä»¥è¦æ‰‹å‹•ç¶å®šåˆ° window

    window.switchTab = function(tab) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-detail').style.display = 'none';
        document.getElementById('view-tools').style.display = 'none';
        document.getElementById('fab-add').style.display = 'none';
        document.querySelector('.back-btn').style.display = 'none';
        document.getElementById('budget-total-bar').style.display = 'none';
        navHistory = [];

        if (tab === 'home') {
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            document.getElementById('page-title').innerText = "COCOç†Šæœ¬ç•¢æ—…";
            document.getElementById('view-dashboard').style.display = 'grid';
            currentView = 'dashboard';
            renderDashboard(); // ç¢ºä¿åˆ‡å›ä¾†æ™‚é‡æ–°æ¸²æŸ“
        } else {
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            document.getElementById('view-tools').style.display = 'block';
            document.getElementById('page-title').innerText = "å·¥å…·ç®±";
            document.getElementById('tools-menu').style.display = 'grid';
            document.getElementById('tool-content').style.display = 'none';
            document.getElementById('budget-notebook').style.display = 'none';
            currentView = 'tools';
        }
    }

    window.handleBack = function() {
        if(navHistory.length > 0) {
            const prevState = navHistory.pop();
            if(prevState === 'tools') {
                document.getElementById('tools-menu').style.display = 'grid';
                document.getElementById('tool-content').style.display = 'none';
                document.getElementById('budget-notebook').style.display = 'none';
                document.getElementById('budget-total-bar').style.display = 'none';
                document.getElementById('fab-add').style.display = 'none';
                document.querySelector('.back-btn').style.display = 'none';
                document.getElementById('page-title').innerText = "å·¥å…·ç®±";
                currentView = 'tools';
            } else if (prevState === 'train-menu') {
                openToolSub('train');
            } else if (prevState === 'budget-menu') {
                openBudgetMenu();
            } else if (prevState === 'dashboard') {
                window.switchTab('home'); // å›é¦–é 
            }
        } else {
            window.switchTab('home');
        }
    }

    // --- Views Rendering ---
    function renderDashboard() {
        const box = document.getElementById('view-dashboard');
        let html = '';
        tripData.forEach((day, idx) => {
            html += `<div class="day-block" onclick="openDay(${idx})"><div class="day-num">${day.date}</div><div class="day-date">${day.fullDate}</div><div class="day-loc">${day.loc}</div><div class="day-weather">${day.weather}</div></div>`;
        });
        box.innerHTML = html;
    }

    window.openDay = function(idx) {
        currentDayIdx = idx;
        navHistory.push('dashboard');
        currentView = 'detail';
        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        document.getElementById('fab-add').style.display = 'flex';
        document.querySelector('.back-btn').style.display = 'block';
        document.getElementById('page-title').innerText = `${tripData[currentDayIdx].fullDate} - ${tripData[currentDayIdx].loc}`;
        renderEvents();
    }

    function renderEvents() {
        const list = document.getElementById('event-list');
        const events = tripData[currentDayIdx].events;
        let html = '';
        if (events.length === 0) { html = '<div style="text-align:center; padding:40px; color:#aaa;">é»æ“Šå³ä¸‹è§’ + æ–°å¢è¡Œç¨‹</div>'; } 
        else {
            events.forEach((evt, idx) => {
                const mapUrl = evt.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' æ—¥æœ¬')}`;
                const costHtml = evt.cost ? `<span class="card-cost">ğŸ’° ${evt.cost}</span>` : '';
                const linkHtml = evt.link ? `<div class="icon-btn btn-link" onclick="window.open('${evt.link}', '_blank')"><i class="fas fa-link"></i></div>` : '';
                html += `<div class="card type-${evt.type}" data-idx="${idx}"><div class="card-row"><div class="card-time">${evt.time}</div><div class="card-content"><div class="card-title">${evt.title}</div>${costHtml}<div class="card-desc">${evt.desc}</div></div><div class="action-btns"><div class="icon-btn" onclick="openItineraryModal(${idx})"><i class="fas fa-pencil-alt"></i></div>${linkHtml}<div class="icon-btn" onclick="window.open('${mapUrl}')"><i class="fas fa-map-marker-alt" style="color:#56CCF2"></i></div></div></div></div>`;
            });
        }
        list.innerHTML = html;
        
        // --- æ’åºè¨­å®šæ›´æ–° (é•·æŒ‰æ‹–æ›³) ---
        new Sortable(list, { 
            animation: 150, 
            delay: 300,            // é•·æŒ‰ 300ms è§¸ç™¼
            delayOnTouchOnly: true,// åƒ…è§¸æ§è£ç½®éœ€é•·æŒ‰
            touchStartThreshold: 5,// æ‰‹æŒ‡ç§»å‹• 5px æ‰ç®—æ‹–æ›³
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                const movedItem = tripData[currentDayIdx].events.splice(evt.oldIndex, 1)[0];
                tripData[currentDayIdx].events.splice(evt.newIndex, 0, movedItem); 
                saveToCloud();
            }
        });
    }

    // --- Tools ---
    window.openToolSub = function(type) {
        const menu = document.getElementById('tools-menu');
        const content = document.getElementById('tool-content');
        menu.style.display = 'none'; content.style.display = 'block'; content.innerHTML = ''; 
        document.querySelector('.back-btn').style.display = 'block';
        if(currentView !== 'tool-sub') navHistory.push('tools');
        currentView = 'tool-sub';

        if(type === 'flight') {
            document.getElementById('page-title').innerText = "èˆªç­è³‡è¨Š";
            content.innerHTML = `<div class="flight-card" onclick="window.open('https://www.google.com/search?q=CI0194+flight+status', '_blank')"><div class="flight-label">2025/01/19 (å»ç¨‹)</div><div class="flight-number">CI 0194</div><div class="flight-route"><span>TPE å°åŒ—</span><i class="fas fa-plane" style="transform: rotate(90deg); color:#56CCF2;"></i><span>KMJ ç†Šæœ¬</span></div><div class="flight-footer"><span>é»æ“ŠæŸ¥çœ‹å‹•æ…‹</span><span>China Airlines</span></div></div><div class="flight-card" onclick="window.open('https://www.google.com/search?q=CI0195+flight+status', '_blank')"><div class="flight-label">2025/01/26 (å›ç¨‹)</div><div class="flight-number">CI 0195</div><div class="flight-route"><span>KMJ ç†Šæœ¬</span><i class="fas fa-plane" style="transform: rotate(90deg); color:#56CCF2;"></i><span>TPE å°åŒ—</span></div><div class="flight-footer"><span>é»æ“ŠæŸ¥çœ‹å‹•æ…‹</span><span>China Airlines</span></div></div>`;
        } else if(type === 'train') {
            document.getElementById('page-title').innerText = "é›»è»Šèˆ‡æ™‚é–“è¡¨";
            content.innerHTML = `<div class="train-menu"><div class="train-block" onclick="openTrainDetail('seats')"><i class="fas fa-chair"></i> é›»è»Šè‡ªç”±åº§</div><div class="train-block" onclick="openTrainDetail('time')"><i class="fas fa-clock"></i> æ™‚é–“è¡¨</div></div>`;
        }
    }

    window.openTrainDetail = function(subType) {
        const content = document.getElementById('tool-content');
        navHistory.push('train-menu');
        if(subType === 'seats') {
            document.getElementById('page-title').innerText = "é›»è»Šè‡ªç”±åº§";
             const trains = [
                {name: "ä¹å·æ–°å¹¹ç·š (ç‘ç©—/æ«»/ç‡•)", cars: "1-3 è™Ÿè»Š", img: "shinkansen.jpg"},
                {name: "ç‰¹æ€¥ Sonic (éŸ³é€Ÿè™Ÿ)", cars: "883ç³»: 4-7 / 885ç³»: 4-6", img: "sonic.jpg"},
                {name: "ç‰¹æ€¥ æ¥åŠ›æµ·é·— (Relay Kamome)", cars: "4-6 è™Ÿè»Š", img: "680.jpg"},
                {name: "è¥¿ä¹å·æ–°å¹¹ç·š (æµ·é·—)", cars: "4-6 è™Ÿè»Š", img: "kyusyu.jpg"},
                {name: "ç‰¹æ€¥ ç”±å¸ƒ (Yufu)", cars: "3 è™Ÿè»Š", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c4/JRK_Kiha185_Yufu_20120908.jpg/640px-JRK_Kiha185_Yufu_20120908.jpg"}
            ];
            let html = ''; trains.forEach(t => html += `<div class="seat-card"><img src="${t.img}" class="seat-img"><div class="seat-info"><div class="seat-name">${t.name}</div><div style="color:#555">è‡ªç”±å¸­ï¼š<span style="background:#27AE60;color:#fff;padding:2px 6px;border-radius:4px;">${t.cars}</span></div></div></div>`);
            content.innerHTML = html;
        } else {
            document.getElementById('page-title').innerText = "JR æ™‚åˆ»è¡¨";
            const stations = [
                {name: "åšå¤šé§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28283"},
                {name: "ç†Šæœ¬é§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28626"},
                {name: "åˆ¥åºœé§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28805"},
                {name: "é•·å´é§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28533"},
                {name: "å°å€‰é§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28155"},
                {name: "æ­¦é›„æ¸©æ³‰é§…", url: "https://www.jrkyushu-timetable.jp/cgi-bin/jr-k_time/tt_dep.cgi?c=28395"},
                {name: "å…¶ä»–ä¹å·è»Šç«™", url: "https://www.jrkyushu.co.jp/railway/station/index.html"}
            ];
            let html = '';
            stations.forEach(s => {
                html += `<div class="link-item" onclick="window.open('${s.url}', '_blank')"><div class="link-icon"><i class="fas fa-train"></i></div><div class="link-info"><div class="link-name">${s.name}</div></div><i class="fas fa-chevron-right" style="color:#ccc;"></i></div>`;
            });
            content.innerHTML = html;
        }
    }

    // --- Budget Logic ---
    window.openBudgetMenu = function() {
        document.getElementById('tools-menu').style.display = 'none';
        document.getElementById('tool-content').style.display = 'block';
        document.getElementById('budget-notebook').style.display = 'none';
        document.getElementById('budget-total-bar').style.display = 'none';
        document.getElementById('fab-add').style.display = 'none';

        document.querySelector('.back-btn').style.display = 'block';
        if(currentView !== 'tool-sub') navHistory.push('tools');
        currentView = 'tool-sub';
        
        document.getElementById('page-title').innerText = "è¨˜å¸³æœ¬ - é¸æ“‡æ—…ä¼´";

        const people = ["ç‹å¿—çœŸ", "ç‹å£«æ™‰", "æ±Ÿç«‘ç·¯", "èƒ¡æœæ˜±", "ä»»ç¿”"];
        let html = '<div class="budget-person-grid">';
        people.forEach(p => {
            html += `<div class="budget-person-card" onclick="openPersonalBudget('${p}')"><div class="avatar-circle">${p[0]}</div><div style="font-weight:bold; font-size:16px;">${p}</div><i class="fas fa-chevron-right" style="margin-left:auto; color:#ccc;"></i></div>`;
        });
        html += '</div>';
        document.getElementById('tool-content').innerHTML = html;
    }

    window.openPersonalBudget = function(name) {
        currentBudgetPerson = name;
        document.getElementById('tool-content').style.display = 'none';
        document.getElementById('budget-notebook').style.display = 'block';
        document.getElementById('budget-total-bar').style.display = 'flex';
        document.getElementById('fab-add').style.display = 'flex';
        document.getElementById('page-title').innerText = `${name} çš„è¨˜å¸³æœ¬`;
        navHistory.push('budget-menu');
        currentView = 'budget-detail';
        renderBudgetList();
    }

    function renderBudgetList() {
        const notebook = document.getElementById('budget-notebook');
        const items = budgetData[currentBudgetPerson] || [];
        let total = 0;
        let html = `<div class="notebook-header"><div style="width:50px;">æ—¥æœŸ</div><div style="width:40px;">ç¨®é¡</div><div style="flex:1;">å…§å®¹</div><div style="width:80px; text-align:right;">é‡‘é¡</div></div>`;
        items.forEach((item, idx) => {
            total += parseInt(item.cost) || 0;
            let icon = item.type=='food'?'ğŸœ':item.type=='transport'?'ğŸš…':item.type=='spot'?'ğŸ«':item.type=='stay'?'ğŸ¨':'ğŸ›ï¸';
            html += `<div class="nb-row" oncontextmenu="openBudgetModal(${idx}); return false;" onclick="openBudgetModal(${idx})"><div class="col-date">${item.date}</div><div class="col-type">${icon}</div><div class="col-content">${item.title}</div><div class="col-cost">${item.cost}</div></div>`;
        });
        if(items.length === 0) html += `<div style="text-align:center; padding:30px; color:#999; font-size:13px;">é»æ“Š + æ–°å¢</div>`;
        notebook.innerHTML = html;
        document.getElementById('total-val').innerText = `Â¥${total}`;
    }

    // --- Handling Input ---
    window.handleAddClick = function() {
        if(currentView === 'detail') openItineraryModal(null);
        else if(currentView === 'budget-detail') openBudgetModal(null);
    }

    window.openItineraryModal = function(idx) {
        const modal = document.getElementById('itinerary-modal');
        editEventIdx = idx;
        const inputs = modal.querySelectorAll('input, select, textarea');
        if (idx === null) {
            inputs.forEach(i => i.value = ""); document.getElementById('inp-type').value = 'spot';
            modal.querySelector('#btn-delete').style.display = 'none';
        } else {
            const evt = tripData[currentDayIdx].events[idx];
            document.getElementById('inp-time').value = evt.time; document.getElementById('inp-type').value = evt.type;
            document.getElementById('inp-title').value = evt.title; document.getElementById('inp-link').value = evt.link||"";
            document.getElementById('inp-map').value = evt.mapUrl||""; document.getElementById('inp-cost').value = evt.cost;
            document.getElementById('inp-desc').value = evt.desc;
            modal.querySelector('#btn-delete').style.display = 'block';
        }
        modal.style.display = 'flex';
    }
    window.closeItineraryModal = () => document.getElementById('itinerary-modal').style.display = 'none';

    window.saveEvent = function() {
        const newEvt = {
            time: document.getElementById('inp-time').value, type: document.getElementById('inp-type').value,
            title: document.getElementById('inp-title').value, link: document.getElementById('inp-link').value,
            mapUrl: document.getElementById('inp-map').value, cost: document.getElementById('inp-cost').value,
            desc: document.getElementById('inp-desc').value
        };
        if (editEventIdx === null) { tripData[currentDayIdx].events.push(newEvt); } 
        else { tripData[currentDayIdx].events[editEventIdx] = newEvt; }
        saveToCloud(); renderEvents(); closeItineraryModal();
    }
    window.deleteEvent = function() { 
        if (confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { 
            tripData[currentDayIdx].events.splice(editEventIdx, 1); 
            saveToCloud(); renderEvents(); closeItineraryModal(); 
        }
    }

    window.openBudgetModal = function(idx) {
        const modal = document.getElementById('budget-modal');
        editingBudgetIdx = idx;
        if (idx === null) {
            document.getElementById('budget-modal-title').innerText = "æ–°å¢æ”¯å‡º";
            document.getElementById('b-date').value = ""; document.getElementById('b-type').value = "food";
            document.getElementById('b-title').value = ""; document.getElementById('b-cost').value = "";
            document.getElementById('b-btn-delete').style.display = 'none';
        } else {
            document.getElementById('budget-modal-title').innerText = "ç·¨è¼¯/åˆªé™¤";
            const item = budgetData[currentBudgetPerson][idx];
            document.getElementById('b-date').value = item.date; document.getElementById('b-type').value = item.type;
            document.getElementById('b-title').value = item.title; document.getElementById('b-cost').value = item.cost;
            document.getElementById('b-btn-delete').style.display = 'block';
        }
        modal.style.display = 'flex';
    }
    window.closeBudgetModal = () => document.getElementById('budget-modal').style.display = 'none';

    window.saveBudgetItem = function() {
        const newItem = {
            date: document.getElementById('b-date').value, type: document.getElementById('b-type').value,
            title: document.getElementById('b-title').value, cost: document.getElementById('b-cost').value
        };
        if(!budgetData[currentBudgetPerson]) budgetData[currentBudgetPerson] = [];
        if(editingBudgetIdx === null) { budgetData[currentBudgetPerson].push(newItem); } 
        else { budgetData[currentBudgetPerson][editingBudgetIdx] = newItem; }
        saveToCloud(); renderBudgetList(); closeBudgetModal();
    }
    window.deleteBudgetItem = function() {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜å¸³ï¼Ÿ")) {
            budgetData[currentBudgetPerson].splice(editingBudgetIdx, 1);
            saveToCloud(); renderBudgetList(); closeBudgetModal();
        }
    }

    // å•Ÿå‹• App
    init();

</script>
</body>
</html>
